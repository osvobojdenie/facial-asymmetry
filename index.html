<!DOCTYPE html>
<html>
	<head>
		<title>Facial asymmetry</title>
		<style type="text/css">
			input {
				margin: 10px 0;
			}
		</style>
	</head>
	<body>
		<div>
			<input id="uploadimage" type="file" name="img" size="65">
		</div>
		<div>
			<canvas id="left" width="10" height="10"></canvas><canvas id="right" width="10" height="10"></canvas>
		</div>
		<div>
			<canvas id="original" width="10" height="10"></canvas>
		</div>
		<script type="text/javascript">
			var canvasOriginal = document.getElementById('original');
			var canvasLeft = document.getElementById('left');
			var canvasRight = document.getElementById('right');
			var ctxOriginal = canvasOriginal.getContext('2d');
			var ctxLeft = canvasLeft.getContext('2d');
			var ctxRight = canvasRight.getContext('2d');
			var img;
			var scale;

			function update() {
				img = new Image();
				var file = document.getElementById('uploadimage').files[0];
				var url = window.URL || window.webkitURL;
				var src = url.createObjectURL(file);
				img.src = src;

				img.onload = function() {
					scale = mirror(img, img.width / 2);
					url.revokeObjectURL(src);
				}
			}

			function mirror(img, leftWidth) {
				var maxWidth = screen.width;
				var maxHeight = screen.height;
				var scale = Math.min(Math.min(maxWidth / img.width, 1), Math.min(maxHeight / img.height, 1));
				var widthScaled = img.width * scale;
				var heightScaled = img.height * scale;
				var rightWidth = img.width - leftWidth;
				var leftWidthScaled = leftWidth * scale;
				var rightWidthScaled = widthScaled - leftWidthScaled;

				canvasOriginal.width = widthScaled;
				canvasOriginal.height = heightScaled;
				canvasLeft.width = leftWidthScaled * 2;
				canvasLeft.height = heightScaled;
				canvasRight.width = rightWidthScaled * 2;
				canvasRight.height = heightScaled;

				ctxOriginal.drawImage(img, 0, 0, img.width, img.height, 0, 0, widthScaled, heightScaled);

				ctxLeft.save();
				ctxLeft.drawImage(img, 0, 0, leftWidth, img.height, 0, 0, leftWidthScaled, heightScaled);
				ctxLeft.scale(-1, 1);
				ctxLeft.drawImage(img, 0, 0, leftWidth, img.height, -leftWidthScaled, 0, -leftWidthScaled, heightScaled);
				ctxLeft.restore();

				ctxRight.save();
				ctxRight.drawImage(img, leftWidth, 0, rightWidth, img.height, rightWidthScaled, 0, rightWidthScaled, heightScaled);
				ctxRight.scale(-1, 1);
				ctxRight.drawImage(img, leftWidth, 0, rightWidth, img.height, 0, 0, -rightWidthScaled, heightScaled);
				ctxRight.restore();

				return scale;
			}

			document.getElementById('uploadimage').addEventListener('change', update);

			function onMouseLeft(event) {
				if (event.which !== 1) {
					return true;
				}

				var rect = this.getBoundingClientRect();
				var x = event.clientX - rect.left;
				scale = mirror(img, Math.min(x / scale, img.width - 1));
				return false;
			}

			function onMouseRight(event) {
				if (event.which !== 1) {
					return true;
				}

				var rect = this.getBoundingClientRect();
				var x = event.clientX - rect.left;
				scale = mirror(img, img.width - Math.min(x / scale, img.width - 1));
				return false;
			}

			canvasLeft.addEventListener('click', onMouseLeft);
			canvasLeft.addEventListener('mousemove', onMouseLeft);
			canvasRight.addEventListener('click', onMouseRight);
			canvasRight.addEventListener('mousemove', onMouseRight);
			canvasOriginal.addEventListener('click', onMouseLeft);
		</script>
	</body>
</html>
